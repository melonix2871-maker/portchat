<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PortChat - Local AI Chat</title>
  <script src="https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.48/+esm"></script>
  <style>
    :root {
      --bg: #0f0f17;
      --text: #e0e0ff;
      --user-bg: #2a2a5a;
      --bot-bg: #1e3a5f;
      --input-bg: #1a1a2e;
      --border: #444;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 12px 16px;
      background: #0a0a14;
      border-bottom: 1px solid var(--border);
      font-weight: bold;
      font-size: 1.1rem;
      text-align: center;
    }
    #chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .message {
      max-width: 85%;
      padding: 12px 16px;
      border-radius: 18px;
      line-height: 1.45;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .user {
      align-self: flex-end;
      background: var(--user-bg);
      border-bottom-right-radius: 4px;
    }
    .assistant {
      align-self: flex-start;
      background: var(--bot-bg);
      border-bottom-left-radius: 4px;
    }
    #input-area {
      padding: 12px 16px;
      background: #0a0a14;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
    }
    #user-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 24px;
      background: var(--input-bg);
      color: white;
      font-size: 1rem;
      outline: none;
      resize: none;
      min-height: 44px;
      max-height: 160px;
    }
    #send-btn {
      padding: 0 20px;
      background: #5a7eff;
      color: white;
      border: none;
      border-radius: 24px;
      font-weight: bold;
      cursor: pointer;
    }
    #send-btn:disabled {
      background: #444;
      cursor: not-allowed;
    }
    #status {
      text-align: center;
      color: #88aaff;
      font-size: 0.9rem;
      padding: 8px;
    }
    .code-block {
      background: #1a1a2e;
      padding: 10px 14px;
      border-radius: 8px;
      overflow-x: auto;
      font-family: 'Consolas', 'Monaco', monospace;
      margin: 8px 0;
    }
  </style>
</head>
<body>

  <header>PortChat â€” Local AI (runs in your browser)</header>

  <div id="status">Loading model... please wait (first time may take a few minutes)</div>

  <div id="chat-container"></div>

  <div id="input-area">
    <textarea id="user-input" rows="1" placeholder="Ask anything..."></textarea>
    <button id="send-btn" disabled>Send</button>
  </div>

  <script type="module">
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //   Configuration â€” change model here if you want
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const MODEL_NAME = "Llama-3.2-3B-Instruct-q4f16_1-MLC";
    // Good alternatives (smaller â†’ faster):
    // "Phi-3.5-mini-instruct-q4f16_1-MLC"
    // "Gemma-2-2b-it-q4f16_1-MLC"
    // "Qwen2.5-3B-Instruct-q4f16_1-MLC"

    let engine = null;
    let currentChat = [];
    const chatContainer = document.getElementById("chat-container");
    const status = document.getElementById("status");
    const input = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");

    // Auto-resize textarea
    input.addEventListener("input", () => {
      input.style.height = "auto";
      input.style.height = (input.scrollHeight) + "px";
    });

    // Send on Enter (without Shift)
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    sendBtn.addEventListener("click", sendMessage);

    async function sendMessage() {
      const text = input.value.trim();
      if (!text || !engine) return;

      addMessage("user", text);
      input.value = "";
      input.style.height = "auto";
      sendBtn.disabled = true;

      currentChat.push({ role: "user", content: text });

      const assistantMsg = addMessage("assistant", "");
      let fullReply = "";

      try {
        const stream = await engine.chat.completions.create({
          messages: currentChat,
          stream: true,
          temperature: 0.7,
          max_tokens: 1024,
        });

        for await (const chunk of stream) {
          const delta = chunk.choices?.[0]?.delta?.content || "";
          if (delta) {
            fullReply += delta;
            assistantMsg.textContent = fullReply;
            chatContainer.scrollTop = chatContainer.scrollHeight;
          }
        }

        currentChat.push({ role: "assistant", content: fullReply });
      } catch (err) {
        assistantMsg.textContent = "Error: " + err.message;
        console.error(err);
      }

      sendBtn.disabled = false;
      input.focus();
    }

    function addMessage(role, content) {
      const div = document.createElement("div");
      div.className = `message ${role}`;
      
      // Very basic markdown â†’ code block handling
      if (content.includes("```")) {
        const parts = content.split(/(```[\s\S]*?```)/g);
        parts.forEach(part => {
          if (part.startsWith("```")) {
            const code = document.createElement("pre");
            code.className = "code-block";
            code.textContent = part.replace(/^```[\w]*\n?/, "").replace(/```$/, "");
            div.appendChild(code);
          } else if (part.trim()) {
            const span = document.createElement("span");
            span.textContent = part;
            div.appendChild(span);
          }
        });
      } else {
        div.textContent = content;
      }

      chatContainer.appendChild(div);
      chatContainer.scrollTop = chatContainer.scrollHeight;
      return div; // return so we can stream into it
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //   Initialize Web-LLM
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function init() {
      try {
        status.textContent = "Downloading model... (can take 3â€“15 min first time)";
        sendBtn.disabled = true;

        const factory = new MLCEngineFactory();
        engine = await factory.createMLCEngine(
          MODEL_NAME,
          {
            initProgressCallback: (report) => {
              status.textContent = report.text;
            }
          }
        );

        status.textContent = "Model loaded! You can start chatting.";
        sendBtn.disabled = false;
        input.focus();

        // Optional welcome message
        addMessage("assistant", "Hi! I'm running locally in your browser using Web-LLM.\nAsk me anything! ðŸš€");
      } catch (err) {
        status.textContent = "Failed to load model: " + err.message;
        console.error(err);
      }
    }

    // Start
    init();
  </script>
</body>
</html>
