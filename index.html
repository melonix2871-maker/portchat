<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
  <title>Junie AI Chat</title>
  <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://js.puter.com/v2/"></script>
  <style>
    :root {
      --bg: #0d1117;
      --text: #c9d1d9;
      --user-bg: #238636;
      --bot-bg: #30363d;
      --input-bg: #161b22;
      --border: #30363d;
      --accent: #58a6ff;
      --header-bg: #010409;
      --status-bg: #165a24;
      --btn-text: #ffffff;
      --dot: rgba(255,255,255,0.3);
    }
    :root[data-theme="light"] {
      --bg: #ffffff;
      --text: #1f2937;
      --user-bg: #e6ffed;
      --bot-bg: #f3f4f6;
      --input-bg: #f3f4f6;
      --border: #d1d5db;
      --accent: #2563eb;
      --header-bg: #f9fafb;
      --status-bg: #b8f3c4;
      --btn-text: #ffffff;
      --dot: rgba(0,0,0,0.3);
    }
    body {
      margin: 0;
      font-family: 'Poppins', system-ui, sans-serif;
      background-color: var(--bg);
      background-image: radial-gradient(var(--dot) 1px, transparent 1px);
      background-size: 15px 15px;
      background-position: 0 0;
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 12px 16px;
      background: var(--header-bg);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    h1 { margin: 0; font-size: 1.4rem; }
    #model-select {
      padding: 8px 12px;
      background: var(--input-bg);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.95rem;
    }
    #status {
      padding: 10px;
      background: var(--status-bg);
      color: var(--text);
      text-align: center;
      font-size: 0.9rem;
    }
    #chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .message {
      max-width: 86%;
      padding: 12px 16px;
      border-radius: 16px;
      line-height: 1.48;
    }
    .user {
      align-self: flex-end;
      background: var(--user-bg);
      border-bottom-right-radius: 4px;
    }
    .assistant {
      align-self: flex-start;
      background: var(--bot-bg);
      border-bottom-left-radius: 4px;
    }
    #input-area {
      padding: 12px 16px;
      background: var(--header-bg);
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
    }
    #user-input {
      flex: 1;
      padding: 12px 18px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--input-bg);
      color: var(--text);
      font-size: 1rem;
      outline: none;
      resize: none;
      min-height: 44px;
      max-height: 160px;
    }
    #send-btn {
      padding: 0 22px;
      background: var(--accent);
      color: var(--btn-text);
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
    }
    #send-btn:disabled {
      background: #444;
      cursor: not-allowed;
    }
    #send-btn:hover{
      background: #3a86ff;
    }
    pre, code {
      background: var(--status-bg);
      padding: 10px 14px;
      border-radius: 8px;
      overflow-x: auto;
      font-family: 'Consolas', 'Courier New', monospace;
      font-size: 0.98rem;
      line-height: 1.8;
    }
    .codebox {
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      background: var(--input-bg);
      margin-top: 6px;
    }
    .codebox-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      font-size: 0.85rem;
      color: var(--text);
    }
    .codebox-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .codebox pre {
      margin: 0;
      line-height: 1.8;
      font-family: 'Consolas', 'Courier New', monospace;
      font-size: 0.98rem;
    }
    @media (max-width: 768px) {
      header {
        padding: 10px 12px;
        gap: 10px;
      }
      h1 { font-size: 1.1rem; }
      #model-select { width: 100%; font-size: 0.9rem; }
      .header-right { width: 100%; justify-content: flex-end; flex-wrap: wrap; }
      #status { padding: 8px; font-size: 0.85rem; }
      #chat-container { padding: 10px; gap: 10px; }
      .message { padding: 10px 12px; max-width: 92%; }
      #input-area { padding: 10px 12px; gap: 8px; }
      #user-input { padding: 10px 14px; min-height: 40px; }
      #send-btn { padding: 0 16px; }
      .codebox-header { padding: 6px 8px; font-size: 0.8rem; }
      pre, code { font-size: 0.9rem; line-height: 1.6; }
    }
    @media (max-width: 480px) {
      h1 { font-size: 1rem; }
      #model-select { font-size: 0.85rem; }
      #send-btn { padding: 0 14px; }
      #send-btn svg { width: 22px; height: 22px; }
      pre, code { font-size: 0.88rem; line-height: 1.55; }
    }
    .codebox-copy {
      padding: 6px 10px;
      border: 1px solid var(--border);
      background: var(--header-bg);
      color: var(--text);
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .logo svg{
        width: 32px;
        height: 32px;
        filter: brightness(0) saturate(100%) invert(66%) sepia(89%) saturate(1952%) hue-rotate(159deg) brightness(96%) contrast(96%);
    }
    .createdby {          
      border: 1px solid var(--border);     
      background: var(--status-bg);
      color: var(--text);
      font-size: 0.9rem;
      text-align: center;
      padding: 8px 12px;
    }
    .createdby a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
    }
    .createdby a:hover {
      text-decoration: underline;
    }
    .createdby .hire-btn {
      margin-top: 8px;
      padding: 8px 12px;
      background: var(--accent);
      color: var(--btn-text);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    .donate {
      position: relative;
    }
    .donate-btn {
      padding: 11px 18px;
    background: var(--accent);
    color: var(--btn-text);
    border: none;
    border-radius: 8px;
    cursor: pointer;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    transition: transform 0.08s ease, filter 0.2s ease;
    text-transform: uppercase;
    font-weight: bold;
    font-family: inherit;
    }
    .donate-btn:hover { filter: brightness(1.05); }
    .donate-btn:active { transform: translateY(1px); }
    .donate-menu {
      position: absolute;
      top: 110%;
      right: 0;
      background: var(--input-bg);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px;
      display: none;
      min-width: 200px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.15);
    }
    .donate-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    .donate-menu button {
      flex: 1;
      padding: 8px 10px;
      border: 1px solid var(--border);
      background: var(--header-bg);
      color: var(--text);
      border-radius: 6px;
      cursor: pointer;
    }
    .donate-menu input {
      flex: 2;
      padding: 8px 10px;
      border: 1px solid var(--border);
      background: var(--input-bg);
      color: var(--text);
      border-radius: 6px;
    }
    .contact-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .contact-modal {
      width: min(520px, 92vw);
      background: var(--header-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
    }
    .contact-modal h3 {
      margin: 0 0 10px 0;
      color: var(--text);
      font-size: 1.05rem;
    }
    .contact-row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    .contact-modal input, .contact-modal textarea {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--border);
      background: var(--input-bg);
      color: var(--text);
      border-radius: 8px;
      font-family: inherit;
    }
    .contact-modal textarea { min-height: 100px; }
    .contact-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }
    .btn-outline {
      padding: 8px 12px;
      border: 1px solid var(--border);
      background: var(--input-bg);
      color: var(--text);
      border-radius: 8px;
      cursor: pointer;
    }
    .btn-primary {
      padding: 8px 12px;
      background: var(--accent);
      color: var(--btn-text);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    .hire-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 18px 28px;
    }
  </style>
</head>
<body>

  <header>
    <h1 style="display: flex; align-items: center; gap: 8px;" class="logo">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2026 Fonticons, Inc.--><path d="M352 0c0-17.7-14.3-32-32-32S288-17.7 288 0l0 64-96 0c-53 0-96 43-96 96l0 224c0 53 43 96 96 96l256 0c53 0 96-43 96-96l0-224c0-53-43-96-96-96l-96 0 0-64zM160 368c0-13.3 10.7-24 24-24l32 0c13.3 0 24 10.7 24 24s-10.7 24-24 24l-32 0c-13.3 0-24-10.7-24-24zm120 0c0-13.3 10.7-24 24-24l32 0c13.3 0 24 10.7 24 24s-10.7 24-24 24l-32 0c-13.3 0-24-10.7-24-24zm120 0c0-13.3 10.7-24 24-24l32 0c13.3 0 24 10.7 24 24s-10.7 24-24 24l-32 0c-13.3 0-24-10.7-24-24zM224 176a48 48 0 1 1 0 96 48 48 0 1 1 0-96zm144 48a48 48 0 1 1 96 0 48 48 0 1 1 -96 0zM64 224c0-17.7-14.3-32-32-32S0 206.3 0 224l0 96c0 17.7 14.3 32 32 32s32-14.3 32-32l0-96zm544-32c-17.7 0-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32s32-14.3 32-32l0-96c0-17.7-14.3-32-32-32z"/></svg>
        Junie AI Chat
    </h1>
     <select id="model-select">
  <option value="TinyLlama-1.1B-Chat-v1.0-q4f32_1-MLC">TinyLlama 1.1B â€“ fastest & most compatible</option>
  <option value="RedPajama-INCITE-Chat-3B-v1-q4f32_1-MLC">RedPajama 3B â€“ very stable</option>
  <option value="Phi-2-q4f32_1-MLC">Phi-2 â€“ good quality & reliable</option>
</select>
   <div class="header-right" style="display: flex; align-items: center; gap: 12px;">
    <label style="display:flex; align-items:center; gap:8px; font-size:0.9rem;">
      <input type="checkbox" id="low-vram"/>
      Low VRAM
    </label>
    <button id="theme-toggle" style="padding:6px 10px; border:1px solid var(--border); background: var(--input-bg); color: var(--text); border-radius:6px; cursor:pointer; display:flex; align-items:center; justify-content:center;"></button>
    <div class="donate">
      <button id="donate-btn" class="donate-btn">Donate</button>
      <div id="donate-menu" class="donate-menu">
        <div class="donate-row">
          <button data-amt="5">$5</button>
          <button data-amt="10">$10</button>
          <button data-amt="25">$25</button>
        </div>
        <div class="donate-row">
          <input id="donate-custom" type="number" min="1" step="1" placeholder="Custom amount"/>
          <button id="donate-go">Go</button>
        </div>
      </div>
    </div>
    </div>
  </header>

  <div id="status">Select a model to beginâ€¦ (first load takes several minutes)</div>

  <div id="chat-container"></div>

  <div id="input-area">
    <textarea id="user-input" rows="1" placeholder="Ask anything..."></textarea>
    <button id="send-btn" disabled>
        
<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
    </button>
  </div>

  <div class="createdby" style="display: flex; align-items: center; gap: 8px; justify-content: space-between; padding-top: 8px;">
    <span> Created by <a href="https://www.linkedin.com/in/asisromeojr20/" target="_blank">Romeo Asis Jr.</a></span>
    <div>
      <button id="hire-btn" class="hire-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-rocket-takeoff-fill" viewBox="0 0 16 16">
  <path d="M12.17 9.53c2.307-2.592 3.278-4.684 3.641-6.218.21-.887.214-1.58.16-2.065a3.6 3.6 0 0 0-.108-.563 2 2 0 0 0-.078-.23V.453c-.073-.164-.168-.234-.352-.295a2 2 0 0 0-.16-.045 4 4 0 0 0-.57-.093c-.49-.044-1.19-.03-2.08.188-1.536.374-3.618 1.343-6.161 3.604l-2.4.238h-.006a2.55 2.55 0 0 0-1.524.734L.15 7.17a.512.512 0 0 0 .433.868l1.896-.271c.28-.04.592.013.955.132.232.076.437.16.655.248l.203.083c.196.816.66 1.58 1.275 2.195.613.614 1.376 1.08 2.191 1.277l.082.202c.089.218.173.424.249.657.118.363.172.676.132.956l-.271 1.9a.512.512 0 0 0 .867.433l2.382-2.386c.41-.41.668-.949.732-1.526zm.11-3.699c-.797.8-1.93.961-2.528.362-.598-.6-.436-1.733.361-2.532.798-.799 1.93-.96 2.528-.361s.437 1.732-.36 2.531Z"/>
  <path d="M5.205 10.787a7.6 7.6 0 0 0 1.804 1.352c-1.118 1.007-4.929 2.028-5.054 1.903-.126-.127.737-4.189 1.839-5.18.346.69.837 1.35 1.411 1.925"/>
</svg> <span>Want me to hire on your projects?</span></button>
    </div>
  </div>

  <div id="contact-backdrop" class="contact-backdrop">
    <div class="contact-modal">
      <h3>Contact Me</h3>
      <form id="contact-form" action="https://formsubmit.co/meoasis2014@gmail.com" method="POST" target="_blank">
        <div class="contact-row">
          <input id="c-name" name="name" type="text" placeholder="Your name" required/>
        </div>
        <div class="contact-row">
          <input id="c-email" name="email" type="email" placeholder="Your email" required/>
        </div>
        <div class="contact-row">
          <textarea id="c-message" name="message" placeholder="Tell me about your projectâ€¦" required></textarea>
        </div>
        <input type="hidden" name="_subject" value="New project inquiry (Junie AI Chat)"/>
        <input type="hidden" name="_template" value="table"/>
        <input type="hidden" name="_captcha" value="false"/>
        <input type="hidden" id="c-next" name="_next" value=""/>
        <div class="contact-actions">
          <button id="c-cancel" type="button" class="btn-outline">Cancel</button>
          <button type="submit" class="btn-primary">Send</button>
        </div>
      </form>
    </div>
  </div>
  <script type="module">
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //   Correct modern import (2025â€“2026 versions)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //import { CreateMLCEngine } from "https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.48/+esm";
    //import { CreateMLCEngine } from "https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm/+esm";

    // Pinned CDN import for stability (JSDelivr ESM)
    import { MLCEngine } from "https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.80/+esm";

    let engine = null;
    let messages = [
      { role: "system", content: "You are a helpful, concise and truthful assistant." }
    ];

    const statusEl        = document.getElementById("status");
    const chatContainer   = document.getElementById("chat-container");
    const userInput       = document.getElementById("user-input");
    const sendBtn         = document.getElementById("send-btn");
    const modelSelect     = document.getElementById("model-select");
    const lowVram         = document.getElementById("low-vram");
    const themeToggle     = document.getElementById("theme-toggle");
    const donateBtn       = document.getElementById("donate-btn");
    const donateMenu      = document.getElementById("donate-menu");
    const donateCustom    = document.getElementById("donate-custom");
    const donateGo        = document.getElementById("donate-go");
    const hireBtn         = document.getElementById("hire-btn");
    const contactBackdrop = document.getElementById("contact-backdrop");
    const contactForm     = document.getElementById("contact-form");
    const cName           = document.getElementById("c-name");
    const cEmail          = document.getElementById("c-email");
    const cMessage        = document.getElementById("c-message");
    const cCancel         = document.getElementById("c-cancel");
    const cNext           = document.getElementById("c-next");
    let engineReady       = false;
    let generating        = false;
    let stopRequested     = false;
    const isMobile        = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
    const SEND_SVG = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>';
    const STOP_SVG = '<svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="#fff" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>';
    let usePuter          = false;
    let mobileModel       = 'gpt-5-nano';

    // Auto-resize input
    userInput.addEventListener("input", () => {
      userInput.style.height = "auto";
      userInput.style.height = userInput.scrollHeight + "px";
    });

    // Enter = send (without shift)
    userInput.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    sendBtn.addEventListener("click", sendMessage);

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //   Load / reload model when selection changes
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadModel() {
      // Mobile: always use Puter (no registration, no keys)
      if (isMobile && window.puter) {
        usePuter = true;
        statusEl.textContent = "Mobile mode: using Puter LLM (no WebGPU required)";
        engineReady = false;
        sendBtn.disabled = false;
        userInput.disabled = false;
        return;
      }
      // Desktop: use selected WebLLM model
      const modelId = modelSelect.value;
      if (!modelId) return;

      statusEl.textContent = `Loading ${modelSelect.options[modelSelect.selectedIndex].text} â€¦`;
      sendBtn.disabled = true;
      userInput.disabled = true;

      try {
        // Create engine, then load model with constrained chat opts to reduce VRAM usage
        engine = new MLCEngine({
          initProgressCallback: report => {
            statusEl.textContent = report.text || "Downloading model filesâ€¦";
          }
        });
        const chatOpts = lowVram.checked ? {
          context_window_size: 1024,
          sliding_window_size: -1,
          attention_sink_size: 128,
          temperature: 0.7
        } : {
          context_window_size: 2048,
          sliding_window_size: -1,
          attention_sink_size: 160,
          temperature: 0.7
        };
        await engine.reload(modelId, chatOpts);

        statusEl.textContent = `Ready â€“ using ${modelSelect.options[modelSelect.selectedIndex].text} ${lowVram.checked ? "(Low VRAM)" : "(Fast Mode)"}`;
        sendBtn.disabled = false;
        userInput.disabled = false;
        userInput.focus();

        addMessage("assistant", `Loaded **${modelSelect.options[modelSelect.selectedIndex].text}** successfully with reduced context for stability.\nAsk me anything ðŸš€`);
        engineReady = true;
      } catch (err) {
        statusEl.textContent = "Error: " + err.message;
        console.error(err);
        engineReady = false;
      }
    }

    modelSelect.addEventListener("change", loadModel);

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //   Send message & stream response
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function sendMessage() {
      const text = userInput.value.trim();
      if (!text || generating) return;

      addMessage("user", text);
      userInput.value = "";
      userInput.style.height = "auto";
      userInput.disabled = true;
      generating = true;
      stopRequested = false;
      sendBtn.innerHTML = STOP_SVG;

      messages.push({ role: "user", content: text });

      const replyDiv = addMessage("assistant", "");
      let fullText = "";

      try {
        if (engineReady && navigator.gpu) {
          const stream = await engine.chat.completions.create({
            messages,
            stream: true,
            temperature: 0.7,
            max_gen_len: lowVram.checked ? 256 : 384
          });
          for await (const chunk of stream) {
            const delta = chunk.choices?.[0]?.delta?.content ?? "";
            fullText += delta;
            replyDiv.innerHTML = marked.parse(fullText);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            if (stopRequested) break;
          }
        } else if (usePuter && window.puter) {
          const response = await puter.ai.chat(text, { model: mobileModel, stream: true });
          for await (const part of response) {
            if (stopRequested) break;
            const delta = part?.text || part?.message?.content?.[0]?.text || part?.content || "";
            if (delta) {
              fullText += delta;
              replyDiv.innerHTML = marked.parse(fullText);
              chatContainer.scrollTop = chatContainer.scrollHeight;
            }
          }
        } else {
          replyDiv.textContent = "Mobile LLM not available. Ensure Puter is reachable or use a desktop with WebGPU.";
        }

        messages.push({ role: "assistant", content: fullText });
        enhanceCodeBlocks(replyDiv);
      } catch (err) {
        const msg = String(err?.message || err);
        // Handle GPU OOM / device lost gracefully by auto-downshifting
        if (msg.includes("GPUOutOfMemoryError") || msg.includes("Device was lost")) {
          statusEl.textContent = "GPU memory issue detected; switching to TinyLlama with smaller contextâ€¦";
          try {
            // Switch to smallest model and tighter limits
            modelSelect.value = "TinyLlama-1.1B-Chat-v1.0-q4f32_1-MLC";
            engine = new MLCEngine({
              initProgressCallback: report => {
                statusEl.textContent = report.text || "Adjusting modelâ€¦";
              }
            });
            await engine.reload(modelSelect.value, {
              context_window_size: 1024,
              sliding_window_size: -1,
              attention_sink_size: 128,
              temperature: 0.7
            });
            statusEl.textContent = "Recovered â€“ TinyLlama ready";
            sendBtn.disabled = false;
            userInput.disabled = false;
            replyDiv.textContent = "Recovery complete. Please resend your question.";
            addMessage("assistant", "Tip: If GPU errors repeat, toggle Low VRAM mode or use a Remote API endpoint for stable performance.");
            engineReady = true;
            generating = false;
            return;
          } catch (e2) {
            replyDiv.textContent = "Recovery failed: " + (e2?.message || String(e2));
            engineReady = false;
          }
        } else if (msg.includes("Tokenizer*") || msg.includes("Buffer unmapped") || msg.includes("BindGroup")) {
          try {
            statusEl.textContent = "Engine validation error; reinitializing with Low VRAMâ€¦";
            if (engine) { try { await engine.resetChat(true); } catch {} }
            engine = new MLCEngine({
              initProgressCallback: report => {
                statusEl.textContent = report.text || "Reinitializingâ€¦";
              }
            });
            modelSelect.value = "TinyLlama-1.1B-Chat-v1.0-q4f32_1-MLC";
            await engine.reload(modelSelect.value, {
              context_window_size: 768,
              sliding_window_size: -1,
              attention_sink_size: 96,
              temperature: 0.7
            });
            statusEl.textContent = "Recovered â€“ TinyLlama (Low VRAM) ready";
            replyDiv.textContent = "Recovery complete. Please resend your question.";
            engineReady = true;
          } catch (e3) {
            replyDiv.textContent = "Recovery failed: " + (e3?.message || String(e3));
            engineReady = false;
          }
        } else {
          replyDiv.textContent = "Error: " + msg;
          console.error(err);
        }
      }

      sendBtn.disabled = false;
      userInput.disabled = false;
      userInput.focus();
      generating = false;
      stopRequested = false;
      sendBtn.innerHTML = SEND_SVG;
    }

    function addMessage(role, content) {
      const div = document.createElement("div");
      div.className = `message ${role}`;
      div.innerHTML = marked.parse(content);
      chatContainer.appendChild(div);
      chatContainer.scrollTop = chatContainer.scrollHeight;
      enhanceCodeBlocks(div);
      return div;
    }

    loadModel();
    

    // Theme persistence and toggle
    (function initTheme() {
      const saved = localStorage.getItem("portchat_theme");
      const theme = (saved === "light" || saved === "dark") ? saved : "light";
      document.documentElement.setAttribute("data-theme", theme);
      const sun = '<svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>';
      const moon = '<svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>';
      const btn = document.getElementById("theme-toggle");
      btn.innerHTML = theme === "light" ? sun : moon;
      btn.setAttribute("aria-label", theme === "light" ? "Light" : "Dark");
    })();
    themeToggle.addEventListener("click", () => {
      const current = document.documentElement.getAttribute("data-theme") || "light";
      const next = current === "dark" ? "light" : "dark";
      document.documentElement.setAttribute("data-theme", next);
      localStorage.setItem("portchat_theme", next);
      const sun = '<svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>';
      const moon = '<svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>';
      themeToggle.innerHTML = next === "light" ? sun : moon;
      themeToggle.setAttribute("aria-label", next === "light" ? "Light" : "Dark");
    });
    const paypalBase = "https://www.paypal.com/paypalme/RomeoJrAsis";
    donateBtn.addEventListener("click", () => {
      donateMenu.style.display = donateMenu.style.display === "block" ? "none" : "block";
    });
    donateMenu.querySelectorAll("[data-amt]").forEach(b => {
      b.addEventListener("click", () => {
        const amt = b.getAttribute("data-amt");
        const url = `${paypalBase}/${amt}`;
        window.open(url, "_blank");
        donateMenu.style.display = "none";
      });
    });
    donateGo.addEventListener("click", () => {
      const v = parseFloat(donateCustom.value);
      if (!isFinite(v) || v <= 0) return;
      const url = `${paypalBase}/${Math.round(v)}`;
      window.open(url, "_blank");
      donateMenu.style.display = "none";
      donateCustom.value = "";
    });
    document.addEventListener("click", (e) => {
      if (!donateMenu.contains(e.target) && !donateBtn.contains(e.target)) {
        donateMenu.style.display = "none";
      }
    });
    hireBtn.addEventListener("click", () => {
      contactBackdrop.style.display = "flex";
      cNext.value = window.location.href;
    });
    cCancel.addEventListener("click", () => {
      contactBackdrop.style.display = "none";
    });
    contactBackdrop.addEventListener("click", (e) => {
      if (e.target === contactBackdrop) contactBackdrop.style.display = "none";
    });
    contactForm.addEventListener("submit", () => {
      // Keep the modal open in background; user lands on thank-you in new tab
      setTimeout(() => { contactBackdrop.style.display = "none"; }, 300);
    });

    document.addEventListener("contextmenu", (e) => { e.preventDefault(); });
    document.addEventListener("keydown", (e) => {
      const k = (e.key || "").toUpperCase();
      const ctrlMeta = e.ctrlKey || e.metaKey;
      const altMeta = e.metaKey && e.altKey;
      const isDevCombo =
        k === "F12" ||
        (ctrlMeta && e.shiftKey && ["I","J","C","K","M","P","S"].includes(k)) ||
        (ctrlMeta && ["U","S","P"].includes(k)) ||
        (altMeta && ["I","J","C","U","M","P","S"].includes(k));
      if (isDevCombo) {
        e.preventDefault();
        e.stopPropagation();
      }
    }, true);
    // CodeMirror runmode integration
    (function loadRunMode(){
      const s1 = document.createElement("script");
      s1.src = "https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/runmode/runmode.min.js";
      document.head.appendChild(s1);
      ["javascript/javascript.min.js","python/python.min.js","xml/xml.min.js","css/css.min.js","htmlmixed/htmlmixed.min.js","shell/shell.min.js"]
      .forEach(m => {
        const s = document.createElement("script");
        s.src = "https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/" + m;
        document.head.appendChild(s);
      });
    })();
    function mapLangToMode(lang) {
      const l = (lang || "").toLowerCase();
      if (["js","javascript","jsx","ts","typescript","tsx"].includes(l)) return "javascript";
      if (["py","python"].includes(l)) return "python";
      if (["html","xml"].includes(l)) return "htmlmixed";
      if (["css"].includes(l)) return "css";
      if (["bash","shell","sh"].includes(l)) return "shell";
      return "javascript";
    }
    function currentCodeThemeClass() {
      const t = document.documentElement.getAttribute("data-theme") || "light";
      return t === "light" ? "cm-s-eclipse" : "cm-s-material-darker";
    }
    function enhanceCodeBlocks(container) {
      const blocks = container.querySelectorAll("pre > code");
      blocks.forEach(code => {
        const pre = code.parentElement;
        if (pre.parentElement && pre.parentElement.classList.contains("codebox")) return;
        const src = code.textContent || "";
        const langClass = Array.from(code.classList).find(c => c.startsWith("language-"));
        const lang = langClass ? langClass.replace("language-","").toUpperCase() : "CODE";
        const wrap = document.createElement("div");
        wrap.className = "codebox";
        const header = document.createElement("div");
        header.className = "codebox-header";
        const label = document.createElement("span");
        label.textContent = lang;
        const actions = document.createElement("div");
        actions.className = "codebox-actions";
        const copyBtn = document.createElement("button");
        copyBtn.className = "codebox-copy";
        copyBtn.textContent = "Copy";
        actions.appendChild(copyBtn);
        header.appendChild(label);
        header.appendChild(actions);
        wrap.appendChild(header);
        wrap.appendChild(pre.cloneNode(true));
        pre.replaceWith(wrap);
        copyBtn.addEventListener("click", async () => {
          try {
            await navigator.clipboard.writeText(src);
            copyBtn.textContent = "Copied";
            setTimeout(() => { copyBtn.textContent = "Copy"; }, 1200);
          } catch {
            const ta = document.createElement("textarea");
            ta.value = src;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            document.body.removeChild(ta);
            copyBtn.textContent = "Copied";
            setTimeout(() => { copyBtn.textContent = "Copy"; }, 1200);
          }
        });
      });
    }
    function refreshCodeThemes() {}
  </script>
</body>
</html>
